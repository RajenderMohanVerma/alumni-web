{% extends 'base.html' %}
{% block content %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&display=swap');

    :root {
        --primary-indigo: #6366f1;
        --secondary-purple: #a855f7;
        --dark-navy: #0f172a;
        --soft-slate: #f1f5f9;
        --glass-white: rgba(255, 255, 255, 0.9);
        --glass-border: rgba(99, 102, 241, 0.1);
    }

    body {
        background: #f8fafc;
        font-family: 'Outfit', sans-serif;
        color: var(--dark-navy);
    }

    .admin-jobs-wrapper {
        padding: 120px 2rem 5rem;
        max-width: 1400px;
        margin: 0 auto;
    }

    .dashboard-hero {
        margin-bottom: 4rem;
        position: relative;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 1.5rem;
        margin-bottom: 3.5rem;
    }

    .stat-card-premium {
        background: var(--glass-white);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 28px;
        padding: 2rem;
        display: flex;
        align-items: center;
        gap: 1.5rem;
        transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.02);
    }

    .stat-card-premium:hover {
        transform: translateY(-8px);
        box-shadow: 0 20px 40px rgba(99, 102, 241, 0.1);
        border-color: var(--primary-indigo);
    }

    .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    .container-glass {
        background: var(--glass-white);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 32px;
        padding: 2.5rem;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.05);
    }

    .filter-bar {
        display: flex;
        gap: 1.5rem;
        margin-bottom: 2.5rem;
        flex-wrap: wrap;
    }

    .search-input-wrapper {
        position: relative;
        flex: 1;
        min-width: 300px;
    }

    .search-input-wrapper i {
        position: absolute;
        left: 20px;
        top: 50%;
        transform: translateY(-50%);
        color: #94a3b8;
    }

    .premium-input {
        width: 100%;
        padding: 14px 20px 14px 50px;
        border-radius: 16px;
        border: 2px solid #e2e8f0;
        background: #f8fafc;
        transition: 0.3s;
        font-weight: 500;
    }

    .premium-input:focus {
        border-color: var(--primary-indigo);
        background: white;
        box-shadow: 0 0 0 5px rgba(99, 102, 241, 0.08);
        outline: none;
    }

    .premium-select {
        padding: 14px 25px;
        border-radius: 16px;
        border: 2px solid #e2e8f0;
        background: #f8fafc;
        font-weight: 600;
        min-width: 180px;
    }

    .job-table-premium {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 15px;
    }

    .job-table-premium thead th {
        font-weight: 800;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        color: #64748b;
        padding: 0 1.5rem;
        border: none;
    }

    .job-item-row {
        background: white;
        transition: 0.3s;
        cursor: pointer;
    }

    .job-item-row:hover {
        transform: scale(1.015);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
    }

    .job-item-row td {
        padding: 1.5rem;
        vertical-align: middle;
        border-top: 1px solid #f1f5f9;
        border-bottom: 1px solid #f1f5f9;
    }

    .job-item-row td:first-child {
        border-left: 1px solid #f1f5f9;
        border-radius: 20px 0 0 20px;
    }

    .job-item-row td:last-child {
        border-right: 1px solid #f1f5f9;
        border-radius: 0 20px 20px 0;
    }

    .company-logo {
        width: 50px;
        height: 50px;
        border-radius: 14px;
        background: #f8fafc;
        overflow: hidden;
        border: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .company-logo img {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }

    .status-badge {
        padding: 6px 16px;
        border-radius: 50px;
        font-weight: 800;
        font-size: 0.7rem;
        text-transform: uppercase;
    }

    .badge-active {
        background: #dcfce7;
        color: #15803d;
    }

    .badge-inactive {
        background: #fee2e2;
        color: #b91c1c;
    }

    .text-navy {
        color: var(--dark-navy);
    }

    .bg-slate-200 {
        background-color: #e2e8f0;
    }

    .text-slate-700 {
        color: #334155;
    }

    .category-badge {
        padding: 6px 14px;
        border-radius: 50px;
        font-weight: 700;
        font-size: 0.75rem;
        background: rgba(99, 102, 241, 0.08);
        color: var(--primary-indigo);
        border: 1px solid rgba(99, 102, 241, 0.15);
        display: inline-block;
    }

    .action-btn-group {
        display: flex;
        gap: 10px;
    }

    .action-circle {
        width: 42px;
        height: 42px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: 0.3s;
        text-decoration: none;
        border: none;
    }

    .btn-view {
        background: #e0e7ff;
        color: #4338ca;
    }

    .btn-edit {
        background: #fef3c7;
        color: #b45309;
    }

    .btn-delete {
        background: #fee2e2;
        color: #b91c1c;
    }

    .action-circle:hover {
        transform: rotate(10deg) scale(1.1);
        filter: brightness(0.95);
    }

    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 26px;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #cbd5e1;
        transition: .4s;
        border-radius: 34px;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }

    input:checked+.slider {
        background-color: var(--primary-indigo);
    }

    input:checked+.slider:before {
        transform: translateX(24px);
    }

    .btn-add-floating {
        background: linear-gradient(135deg, var(--primary-indigo), var(--secondary-purple));
        color: white;
        padding: 1.2rem 2.5rem;
        border-radius: 20px;
        font-weight: 800;
        box-shadow: 0 15px 30px rgba(99, 102, 241, 0.3);
        text-decoration: none;
        transition: 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 10px;
    }

    .btn-add-floating:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(99, 102, 241, 0.5);
        color: white;
    }
</style>

<div class="admin-jobs-wrapper">
    <!-- Header -->
    <div class="dashboard-hero d-flex justify-content-between align-items-end" data-aos="fade-down">
        <div>
            <h1 class="fw-800 display-4 mb-2">Career Nodes Matrix</h1>
            <p class="text-muted fs-5">Manage and monitor professional opportunities within the alumni network.</p>
        </div>
        <a href="{{ url_for('admin_add_job') }}" class="btn-add-floating">
            <i class="fas fa-plus-circle"></i> Deploy New Node
        </a>
    </div>

    <!-- Stats -->
    <div class="stats-grid">
        <div class="stat-card-premium" data-aos="zoom-in" data-aos-delay="100">
            <div class="stat-icon bg-primary-subtle text-primary">
                <i class="fas fa-briefcase"></i>
            </div>
            <div>
                <div class="text-muted small fw-bold">TOTAL POSTINGS</div>
                <div class="fs-2 fw-800">{{ stats.total }}</div>
            </div>
        </div>
        <div class="stat-card-premium" data-aos="zoom-in" data-aos-delay="200">
            <div class="stat-icon bg-success-subtle text-success">
                <i class="fas fa-check-circle"></i>
            </div>
            <div>
                <div class="text-muted small fw-bold">ACTIVE NODES</div>
                <div class="fs-2 fw-800 text-success">{{ stats.active }}</div>
            </div>
        </div>
        <div class="stat-card-premium" data-aos="zoom-in" data-aos-delay="300">
            <div class="stat-icon bg-warning-subtle text-warning">
                <i class="fas fa-hourglass-end"></i>
            </div>
            <div>
                <div class="text-muted small fw-bold">EXPIRED / CLOSED</div>
                <div class="fs-2 fw-800 text-warning">{{ stats.expired }}</div>
            </div>
        </div>
        <div class="stat-card-premium" data-aos="zoom-in" data-aos-delay="400">
            <div class="stat-icon bg-danger-subtle text-danger">
                <i class="fas fa-eye-slash"></i>
            </div>
            <div>
                <div class="text-muted small fw-bold">HIDDEN / INACTIVE</div>
                <div class="fs-2 fw-800 text-danger">{{ stats.inactive }}</div>
            </div>
        </div>
    </div>

    <!-- Main Table -->
    <div class="container-glass animate__animated animate__fadeInUp">
        <div class="filter-bar">
            <div class="search-input-wrapper">
                <i class="fas fa-search"></i>
                <input type="text" id="jobSearch" class="premium-input"
                    placeholder="Query nodes by title, entity or category...">
            </div>
            <select class="premium-select" id="roleFilter">
                <option value="all">Every Classification</option>
                <option value="Technology">Technology</option>
                <option value="Design">Design</option>
                <option value="Business">Business</option>
                <option value="Marketing">Marketing</option>
            </select>
            <select class="premium-select" id="statusFilter">
                <option value="all">All States</option>
                <option value="active">Active Only</option>
                <option value="inactive">Inactive Only</option>
            </select>
        </div>

        <div class="table-responsive">
            <table class="job-table-premium">
                <thead>
                    <tr>
                        <th>Node Identity</th>
                        <th>Classification</th>
                        <th>Protocol & Mode</th>
                        <th>Rewards & Area</th>
                        <th>Eligibility</th>
                        <th>Operations</th>
                        <th>Control</th>
                    </tr>
                </thead>
                <tbody id="jobTableBody">
                    {% for job in jobs %}
                    <tr class="job-item-row" data-title="{{ job.title | lower }}"
                        data-company="{{ job.company | lower }}" data-category="{{ job.category }}"
                        data-status="{{ 'active' if job.is_active else 'inactive' }}">
                        <td>
                            <div class="d-flex align-items-center gap-3">
                                <div class="company-logo">
                                    {% if job.company_logo %}
                                    <img src="{{ job.company_logo }}" alt="Logo">
                                    {% else %}
                                    <span class="fw-bold text-primary">{{ job.company[0] }}</span>
                                    {% endif %}
                                </div>
                                <div>
                                    <div class="fw-800 text-navy">{{ job.title }}</div>
                                    <div class="text-muted small">{{ job.company }}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="category-badge">{{ job.category or 'General' }}</span>
                        </td>
                        <td>
                            <div class="fw-bold">{{ job.employment_type or 'Full-time' }}</div>
                            <span
                                class="badge {{ 'bg-success-subtle text-success' if job.work_mode == 'Remote' else 'bg-primary-subtle text-primary' }} rounded-pill px-3 mt-1"
                                style="font-size: 0.65rem;">
                                {{ job.work_mode or 'Onsite' }}
                            </span>
                        </td>
                        <td>
                            <div class="fw-bold text-success">{{ job.salary or 'Unspecified' }}</div>
                            <div class="text-muted extra-small"><i class="fas fa-map-marker-alt me-1"></i> {{
                                job.location or 'Remote' }}</div>
                        </td>
                        <td>
                            <div class="fw-bold text-indigo">{{ job.eligible_branch or 'All' }}</div>
                            <div class="text-muted small">{{ job.openings or '1' }} Openings</div>
                        </td>
                        <td>
                            <label class="toggle-switch">
                                <input type="checkbox" class="status-toggle-input" data-job-id="{{ job.id }}" {% if
                                    job.is_active %}checked{% endif %}>
                                <span class="slider"></span>
                            </label>
                        </td>
                        <td>
                            <div class="action-btn-group">
                                <a href="{{ url_for('admin_edit_job', job_id=job.id) }}" class="action-circle btn-edit"
                                    title="Modify Parameters">
                                    <i class="fas fa-sliders-h"></i>
                                </a>
                                <form action="{{ url_for('admin_delete_job', job_id=job.id) }}" method="POST"
                                    onsubmit="return confirm('DANGER: Permanently delete this career node?');"
                                    style="display: inline;">
                                    <button type="submit" class="action-circle btn-delete" title="Terminate Node">
                                        <i class="fas fa-microchip"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // Real-time Filtering Logic
    const searchInput = document.getElementById('jobSearch');
    const roleFilter = document.getElementById('roleFilter');
    const statusFilter = document.getElementById('statusFilter');
    const rows = document.querySelectorAll('.job-item-row');

    function filterTable() {
        const query = searchInput.value.toLowerCase();
        const role = roleFilter.value;
        const status = statusFilter.value;

        rows.forEach(row => {
            const title = row.dataset.title;
            const company = row.dataset.company;
            const category = row.dataset.category;
            const itemStatus = row.dataset.status;

            const matchesQuery = title.includes(query) || company.includes(query);
            const matchesRole = role === 'all' || category === role;
            const matchesStatus = status === 'all' || itemStatus === status;

            if (matchesQuery && matchesRole && matchesStatus) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    // Dynamic Status Toggle Implementation
    document.querySelectorAll('.status-toggle-input').forEach(toggle => {
        toggle.addEventListener('change', function () {
            const jobId = this.dataset.jobId;
            toggleJobStatus(jobId, this);
        });
    });

    async function toggleJobStatus(jobId, checkbox) {
        try {
            const response = await fetch(`/api/admin/jobs/toggle/${jobId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const data = await response.json();
            if (data.success) {
                // Update row data-status for filtering
                const row = checkbox.closest('tr');
                row.dataset.status = data.new_status ? 'active' : 'inactive';

                // Optional: Show toast notification
                const statusText = data.new_status ? 'Activated' : 'Deactivated';
                console.log(`Job ${jobId} ${statusText}`);
            } else {
                checkbox.checked = !checkbox.checked;
                alert('Matrix Error: Failed to update node status.');
            }
        } catch (error) {
            checkbox.checked = !checkbox.checked;
            console.error('Core sync failure:', error);
        }
    }
</script>
{% endblock %}